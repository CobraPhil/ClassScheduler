<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finals Schedule Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .tabs {
            display: flex;
            background: #e9ecef;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: #e9ecef;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }
        .tab:hover {
            background: #dee2e6;
        }
        .tab.active:hover {
            background: white;
        }
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .file-input {
            display: none;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 10px 5px;
            display: inline-block;
            text-decoration: none;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .class-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 20px 0;
        }
        .class-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .class-item:hover {
            background-color: #f8f9fa;
        }
        .class-item:last-child {
            border-bottom: none;
        }
        .class-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .class-info {
            flex: 1;
        }
        .class-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .class-details {
            color: #666;
            font-size: 14px;
        }
        .schedule-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .alert {
            padding: 15px 20px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .alert-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .alert-info {
            background-color: #d7f3ff;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            opacity: 0.9;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .schedule-type-card {
            border: 3px solid #dee2e6;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .schedule-type-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        .schedule-type-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        .schedule-type-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
        .schedule-type-card p {
            margin: 0 0 20px 0;
            opacity: 0.9;
        }
        .schedule-type-card ul {
            list-style-position: inside;
            padding: 0;
        }
        .schedule-type-card.selected ul {
            color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Schedule Generator</h1>
            <p>Generate conflict-free finals schedules or classroom schedules from class enrollment PDFs</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('upload')">1. Upload PDF</div>
            <div class="tab" onclick="showTab('select')">2. Select Classes</div>
            <div class="tab" onclick="showTab('scheduletype')">3. Schedule Type</div>
            <div class="tab" onclick="showTab('schedule')">4. Generate Schedule</div>
        </div>
        
        <!-- Tab 1: Upload PDF -->
        <div id="upload" class="tab-content active">
            <h2>Upload Class Enrollment PDF</h2>
            <p>Select a PDF file containing class enrollment data. The application will automatically parse student enrollments and combine English (E) and Pidgin (P) sections.</p>
            
            <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
                <h3>üìÅ Click to select PDF file</h3>
                <p>or drag and drop your PDF file here</p>
                <input type="file" id="pdfFile" class="file-input" accept=".pdf">
            </div>
            
            <button class="btn" onclick="uploadPDF()" id="uploadBtn" disabled>Process PDF</button>
            
            <div id="uploadLog" class="log" style="display: none;"></div>
        </div>
        
        <!-- Tab 2: Select Classes -->
        <div id="select" class="tab-content">
            <h2>Select Classes</h2>
            <p>Review the classes below. You can manually combine related classes before selecting which classes to include in your schedule.</p>
            
            <div class="stats-grid" id="classStats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalClasses">0</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedClasses">0</div>
                    <div class="stat-label">Selected Classes</div>
                </div>
            </div>
            
            <!-- Manual Class Combination Section -->
            <div id="combineSection" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none;">
                <h3>üìã Combine Related Classes</h3>
                <p>Select multiple related classes (e.g., different sections of the same course) to combine them into a single class for scheduling.</p>
                
                <div style="margin: 15px 0;">
                    <button class="btn btn-secondary" onclick="toggleCombineMode()" id="combineToggleBtn">Enable Combine Mode</button>
                    <button class="btn" onclick="showCombineDialog()" id="combineBtn" style="display: none;" disabled>Combine Selected Classes</button>
                    <button class="btn btn-secondary" onclick="cancelCombineMode()" id="cancelCombineBtn" style="display: none;">Cancel</button>
                </div>
                
                <div id="combineInstructions" style="display: none; padding: 10px; background: #fff3cd; border-radius: 5px; margin: 10px 0;">
                    <strong>Combine Mode Active:</strong> Select multiple classes using the round buttons, then click "Combine Selected Classes"
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                <button class="btn btn-secondary" onclick="resetToUploadState()" id="resetBtn" style="margin-left: 20px;">Reset to Upload State</button>
                <button class="btn" onclick="confirmSelection()" id="confirmBtn" disabled>Confirm Selection</button>
            </div>
            
            <div id="classList" class="class-list"></div>
        </div>
        
        <!-- Combine Classes Modal -->
        <div id="combineModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px; max-width: 600px;">
                <h3>Combine Classes</h3>
                <p>You are combining <span id="combineCount">0</span> classes:</p>
                <ul id="combineList" style="margin: 15px 0; padding-left: 20px;"></ul>
                
                <div style="margin: 20px 0;">
                    <label for="combinedName" style="display: block; margin-bottom: 5px; font-weight: bold;">Combined Class Name:</label>
                    <input type="text" id="combinedName" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeCombineModal()" style="margin-right: 10px;">Cancel</button>
                    <button class="btn" onclick="performCombine()">Combine Classes</button>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: Schedule Type Selection -->
        <div id="scheduletype" class="tab-content">
            <h2>Choose Schedule Type</h2>
            <p>Select whether you want to generate a finals schedule or a classroom schedule.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
                <div class="schedule-type-card" id="finalsCard" onclick="selectScheduleType('finals')">
                    <h3>üìù Finals Schedule</h3>
                    <p>Generate a sequential schedule for final examinations with time slots.</p>
                    <ul style="text-align: left; margin: 20px 0;">
                        <li>Sequential time slots</li>
                        <li>Auto-combines English/Pidgin sections</li>
                        <li>Maximum 3 classes per time slot</li>
                        <li>Optimized for exam periods</li>
                    </ul>
                </div>
                
                <div class="schedule-type-card" id="classroomCard" onclick="selectScheduleType('classroom')">
                    <h3>üè´ Classroom Schedule</h3>
                    <p>Generate concurrent groups for regular weekly classes.</p>
                    <ul style="text-align: left; margin: 20px 0;">
                        <li>Concurrent class groups</li>
                        <li>Manual class control (no auto-combining)</li>
                        <li>Student and teacher conflict prevention</li>
                        <li>Minimum groups optimization</li>
                    </ul>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn" onclick="proceedToGeneration()" id="proceedBtn" disabled>Proceed to Generation</button>
            </div>
        </div>
        
        <!-- Tab 4: Generate Schedule -->
        <div id="schedule" class="tab-content">
            <h2 id="scheduleTitle">Generate Schedule</h2>
            <p id="scheduleDescription">Generate your selected schedule type.</p>
            
            <button class="btn" onclick="generateSchedule()" id="generateBtn" disabled>Generate Schedule</button>
            <button class="btn btn-success" onclick="exportSchedule()" id="exportBtn" style="display: none;">Export Schedule</button>
            
            <div id="scheduleStats" class="stats-grid" style="display: none;"></div>
            <div id="scheduleOutput" class="schedule-output" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentClasses = [];
        let selectedClassNames = new Set();
        let combineMode = false;
        let classesToCombine = new Set();
        let selectedScheduleType = null;
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Insert at the top of current active tab
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(alertDiv, activeTab.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
        
        function updateLog(message) {
            const log = document.getElementById('uploadLog');
            log.style.display = 'block';
            log.textContent += message + '\n';
            log.scrollTop = log.scrollHeight;
        }
        
        // File upload handling
        document.getElementById('pdfFile').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('uploadBtn').disabled = false;
                updateLog(`Selected file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            }
        });
        
        // Drag and drop
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function() {
            this.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                document.getElementById('pdfFile').files = files;
                document.getElementById('uploadBtn').disabled = false;
                updateLog(`Dropped file: ${files[0].name}`);
            } else {
                showAlert('Please drop a PDF file', 'error');
            }
        });
        
        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select a PDF file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf_file', file);
            
            updateLog('Processing PDF...');
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateLog(`‚úì Found ${result.classes_found} raw classes`);
                    updateLog(`‚úì Combined ${result.combined_count} E/P sections`);
                    updateLog(`‚úì Final class count: ${result.final_count}`);
                    updateLog('‚úì Processing complete!');
                    
                    currentClasses = result.classes;
                    populateClassList();
                    showTab('select');
                    showAlert('PDF processed successfully!', 'success');
                } else {
                    updateLog(`‚úó Error: ${result.error}`);
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                updateLog(`‚úó Network error: ${error.message}`);
                showAlert('Network error occurred', 'error');
            }
            
            document.getElementById('uploadBtn').disabled = false;
        }
        
        function populateClassList() {
            const classList = document.getElementById('classList');
            classList.innerHTML = '';
            
            selectedClassNames.clear();
            classesToCombine.clear();
            
            currentClasses.forEach((cls, index) => {
                if (cls.selected) {
                    selectedClassNames.add(cls.name);
                }
                
                const item = document.createElement('div');
                item.className = 'class-item';
                
                // Create different checkbox types based on mode
                let checkboxHtml;
                if (combineMode) {
                    checkboxHtml = `
                        <input type="checkbox" class="class-combine-checkbox" 
                               onchange="toggleCombineClass('${cls.name}', this.checked)"
                               style="margin-right: 15px; transform: scale(1.2); accent-color: #ff6b6b;">
                    `;
                } else {
                    checkboxHtml = `
                        <input type="checkbox" class="class-checkbox" 
                               ${cls.selected ? 'checked' : ''} 
                               onchange="toggleClass('${cls.name}', this.checked)">
                    `;
                }
                
                // Display class type if available
                const classTypeDisplay = cls.class_type ? ` ‚Ä¢ [${cls.class_type}]` : '';
                
                item.innerHTML = `
                    ${checkboxHtml}
                    <div class="class-info">
                        <div class="class-name">${cls.name}</div>
                        <div class="class-details">${cls.teacher} ‚Ä¢ ${cls.student_count} students${classTypeDisplay}</div>
                    </div>
                `;
                
                classList.appendChild(item);
            });
            
            updateClassStats();
            document.getElementById('classStats').style.display = 'grid';
            document.getElementById('combineSection').style.display = 'block';
            document.getElementById('confirmBtn').disabled = false;
        }
        
        function toggleClass(className, selected) {
            if (selected) {
                selectedClassNames.add(className);
            } else {
                selectedClassNames.delete(className);
            }
            updateClassStats();
        }
        
        function updateClassStats() {
            document.getElementById('totalClasses').textContent = currentClasses.length;
            document.getElementById('selectedClasses').textContent = selectedClassNames.size;
        }
        
        function selectAll() {
            document.querySelectorAll('.class-checkbox').forEach(cb => {
                cb.checked = true;
                const className = cb.parentNode.querySelector('.class-name').textContent;
                selectedClassNames.add(className);
            });
            updateClassStats();
        }
        
        function selectNone() {
            document.querySelectorAll('.class-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedClassNames.clear();
            updateClassStats();
        }
        
        async function confirmSelection() {
            if (selectedClassNames.size === 0) {
                showAlert('Please select at least one class', 'error');
                return;
            }
            
            try {
                const response = await fetch('/set_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selected_classes: Array.from(selectedClassNames)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`${result.selected_count} classes selected`, 'success');
                    showTab('scheduletype');
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }
        
        function selectScheduleType(type) {
            selectedScheduleType = type;
            
            // Remove selected class from both cards
            document.getElementById('finalsCard').classList.remove('selected');
            document.getElementById('classroomCard').classList.remove('selected');
            
            // Add selected class to chosen card
            document.getElementById(type + 'Card').classList.add('selected');
            
            // Enable proceed button
            document.getElementById('proceedBtn').disabled = false;
        }
        
        function proceedToGeneration() {
            if (!selectedScheduleType) {
                showAlert('Please select a schedule type', 'error');
                return;
            }
            
            // Update UI based on schedule type
            if (selectedScheduleType === 'finals') {
                document.getElementById('scheduleTitle').textContent = 'Generate Finals Schedule';
                document.getElementById('scheduleDescription').textContent = 'Generate a conflict-free finals schedule ensuring no student takes multiple finals simultaneously and no teacher gives multiple finals at the same time.';
                document.getElementById('generateBtn').textContent = 'Generate Finals Schedule';
            } else {
                document.getElementById('scheduleTitle').textContent = 'Generate Classroom Schedule';
                document.getElementById('scheduleDescription').textContent = 'Generate optimal concurrent class groups with minimum number of groups while preventing student and teacher conflicts.';
                document.getElementById('generateBtn').textContent = 'Generate Classroom Schedule';
            }
            
            document.getElementById('generateBtn').disabled = false;
            showTab('schedule');
        }
        
        async function resetToUploadState() {
            try {
                const response = await fetch('/reset_to_upload_state', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the class list to original upload state
                    currentClasses = result.classes;
                    
                    // Reset UI state
                    selectedScheduleType = null;
                    document.getElementById('finalsCard').classList.remove('selected');
                    document.getElementById('classroomCard').classList.remove('selected');
                    document.getElementById('proceedBtn').disabled = true;
                    
                    // Clear any generated schedules
                    document.getElementById('scheduleStats').style.display = 'none';
                    document.getElementById('scheduleOutput').style.display = 'none';
                    document.getElementById('exportBtn').style.display = 'none';
                    
                    // Exit combine mode if active
                    if (combineMode) {
                        cancelCombineMode();
                    }
                    
                    // Refresh the class selection display with original state
                    populateClassList();
                    
                    // Stay on current tab (Select Classes)
                    showAlert(`Reset complete: ${result.total_count} classes restored to original upload state`, 'success');
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }
        
        async function generateSchedule() {
            const output = document.getElementById('scheduleOutput');
            const stats = document.getElementById('scheduleStats');
            
            // Show loading
            output.style.display = 'block';
            output.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating conflict-free schedule...</p>
                </div>
            `;
            
            try {
                const endpoint = selectedScheduleType === 'classroom' ? '/generate_classroom_schedule' : '/generate';
                const response = await fetch(endpoint, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (selectedScheduleType === 'classroom') {
                        displayClassroomSchedule(result.schedule);
                    } else {
                        displaySchedule(result.schedule);
                    }
                    showAlert('Schedule generated successfully!', 'success');
                } else {
                    output.innerHTML = `Error: ${result.error}`;
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                output.innerHTML = `Network error: ${error.message}`;
                showAlert('Network error occurred', 'error');
            }
        }
        
        function displaySchedule(schedule) {
            const output = document.getElementById('scheduleOutput');
            const stats = document.getElementById('scheduleStats');
            
            // Display stats
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${schedule.stats.total_slots}</div>
                    <div class="stat-label">Time Slots</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${schedule.stats.total_classes}</div>
                    <div class="stat-label">Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${schedule.stats.total_conflicts}</div>
                    <div class="stat-label">Conflicts Resolved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${schedule.is_conflict_free ? '‚úì' : '‚ùå'}</div>
                    <div class="stat-label">Conflict Free</div>
                </div>
            `;
            stats.style.display = 'grid';
            
            // Display schedule
            let scheduleText = 'FINALS SCHEDULE\n';
            scheduleText += '='.repeat(50) + '\n\n';
            scheduleText += `Total Time Slots Required: ${schedule.stats.total_slots}\n`;
            scheduleText += `Total Classes: ${schedule.stats.total_classes}\n`;
            scheduleText += `Total Conflicts Resolved: ${schedule.stats.total_conflicts}\n\n`;
            
            schedule.timeslots.forEach((slot, index) => {
                scheduleText += `Time Slot ${index + 1}:\n`;
                slot.forEach(className => {
                    const classData = currentClasses.find(c => c.name === className);
                    scheduleText += `  ‚Ä¢ ${className} - ${classData.teacher} (${classData.student_count} students)\n`;
                });
                scheduleText += '\n';
            });
            
            // Verification
            scheduleText += 'VERIFICATION:\n';
            scheduleText += '-'.repeat(30) + '\n';
            
            schedule.verification.forEach(result => {
                if (result.conflicts.length === 0) {
                    scheduleText += `‚úì Time Slot ${result.slot}: No conflicts\n`;
                } else {
                    scheduleText += `‚ùå Time Slot ${result.slot}: ${result.conflicts.length} conflicts\n`;
                    result.conflicts.forEach(conflict => {
                        scheduleText += `   ${conflict.type} conflict: ${conflict.class1} vs ${conflict.class2}\n`;
                        if (conflict.shared_students.length > 0) {
                            scheduleText += `   Shared students: ${conflict.shared_students.join(', ')}\n`;
                        }
                    });
                }
            });
            
            if (schedule.is_conflict_free) {
                scheduleText += '\nüéâ SUCCESS: Schedule is completely conflict-free!\n';
                scheduleText += '‚úì No student has multiple finals at the same time\n';
                scheduleText += '‚úì No teacher gives multiple finals at the same time\n';
            } else {
                scheduleText += '\n‚ùå WARNING: Conflicts detected in schedule!\n';
            }
            
            output.textContent = scheduleText;
            document.getElementById('exportBtn').style.display = 'inline-block';
        }
        
        function displayClassroomSchedule(schedule) {
            const output = document.getElementById('scheduleOutput');
            const stats = document.getElementById('scheduleStats');
            
            // Display stats
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${schedule.stats.total_groups}</div>
                    <div class="stat-label">Concurrent Groups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${schedule.stats.total_classes}</div>
                    <div class="stat-label">Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${schedule.stats.student_conflicts + schedule.stats.teacher_conflicts}</div>
                    <div class="stat-label">Conflicts Resolved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${schedule.is_conflict_free ? '‚úì' : '‚ùå'}</div>
                    <div class="stat-label">Conflict Free</div>
                </div>
            `;
            stats.style.display = 'grid';
            
            // Display schedule
            let scheduleText = 'CLASSROOM SCHEDULE\n';
            scheduleText += '='.repeat(50) + '\n\n';
            scheduleText += `Total Concurrent Groups: ${schedule.stats.total_groups}\n`;
            scheduleText += `Total Classes: ${schedule.stats.total_classes}\n`;
            scheduleText += `Student Conflicts Resolved: ${schedule.stats.student_conflicts}\n`;
            scheduleText += `Teacher Conflicts Resolved: ${schedule.stats.teacher_conflicts}\n\n`;
            
            schedule.groups.forEach((group) => {
                scheduleText += `Concurrent Group ${group.group_number}:\n`;
                group.classes.forEach(classInfo => {
                    scheduleText += `  ‚Ä¢ ${classInfo.name} - ${classInfo.teacher} (${classInfo.student_count} students) [${classInfo.class_type}]\n`;
                });
                scheduleText += '\n';
            });
            
            // Verification
            scheduleText += 'VERIFICATION:\n';
            scheduleText += '-'.repeat(30) + '\n';
            
            schedule.verification.forEach(result => {
                if (result.conflicts.length === 0) {
                    scheduleText += `‚úì Group ${result.group}: No conflicts\n`;
                } else {
                    scheduleText += `‚ùå Group ${result.group}: ${result.conflicts.length} conflicts\n`;
                    result.conflicts.forEach(conflict => {
                        scheduleText += `   ${conflict.type} conflict: ${conflict.class1} vs ${conflict.class2}\n`;
                        if (conflict.shared_students && conflict.shared_students.length > 0) {
                            scheduleText += `   Shared students: ${conflict.shared_students.join(', ')}\n`;
                        }
                    });
                }
            });
            
            if (schedule.is_conflict_free) {
                scheduleText += '\nüéâ SUCCESS: Classroom schedule is completely conflict-free!\n';
                scheduleText += '‚úì No student has multiple classes at the same time\n';
                scheduleText += '‚úì No teacher teaches multiple classes at the same time\n';
            } else {
                scheduleText += '\n‚ùå WARNING: Conflicts detected in classroom schedule!\n';
            }
            
            output.textContent = scheduleText;
            document.getElementById('exportBtn').style.display = 'inline-block';
        }
        
        function exportSchedule() {
            const exportUrl = selectedScheduleType === 'classroom' ? '/export_classroom' : '/export';
            window.location.href = exportUrl;
        }
        
        // Class combining functions
        function toggleCombineMode() {
            combineMode = !combineMode;
            classesToCombine.clear();
            
            if (combineMode) {
                document.getElementById('combineToggleBtn').textContent = 'Exit Combine Mode';
                document.getElementById('combineBtn').style.display = 'inline-block';
                document.getElementById('cancelCombineBtn').style.display = 'inline-block';
                document.getElementById('combineInstructions').style.display = 'block';
            } else {
                document.getElementById('combineToggleBtn').textContent = 'Enable Combine Mode';
                document.getElementById('combineBtn').style.display = 'none';
                document.getElementById('cancelCombineBtn').style.display = 'none';
                document.getElementById('combineInstructions').style.display = 'none';
            }
            
            populateClassList();
            updateCombineButton();
        }
        
        function cancelCombineMode() {
            combineMode = false;
            classesToCombine.clear();
            document.getElementById('combineToggleBtn').textContent = 'Enable Combine Mode';
            document.getElementById('combineBtn').style.display = 'none';
            document.getElementById('cancelCombineBtn').style.display = 'none';
            document.getElementById('combineInstructions').style.display = 'none';
            populateClassList();
        }
        
        function toggleCombineClass(className, selected) {
            if (selected) {
                classesToCombine.add(className);
            } else {
                classesToCombine.delete(className);
            }
            updateCombineButton();
        }
        
        function updateCombineButton() {
            const combineBtn = document.getElementById('combineBtn');
            combineBtn.disabled = classesToCombine.size < 2;
            combineBtn.textContent = `Combine Selected Classes (${classesToCombine.size})`;
        }
        
        function showCombineDialog() {
            if (classesToCombine.size < 2) {
                showAlert('Please select at least 2 classes to combine', 'error');
                return;
            }
            
            // Populate the modal
            document.getElementById('combineCount').textContent = classesToCombine.size;
            
            const combineList = document.getElementById('combineList');
            combineList.innerHTML = '';
            
            // Suggest a combined name based on the first class
            let suggestedName = '';
            let first = true;
            
            classesToCombine.forEach(className => {
                const li = document.createElement('li');
                li.textContent = className;
                combineList.appendChild(li);
                
                if (first) {
                    // Try to extract base course name for suggestion
                    suggestedName = className.replace(/\s+(English|Pidgin|pidgin|self study).*$/i, '').trim();
                    first = false;
                }
            });
            
            document.getElementById('combinedName').value = suggestedName;
            document.getElementById('combineModal').style.display = 'block';
        }
        
        function closeCombineModal() {
            document.getElementById('combineModal').style.display = 'none';
        }
        
        async function performCombine() {
            const combinedName = document.getElementById('combinedName').value.trim();
            
            if (!combinedName) {
                showAlert('Please enter a name for the combined class', 'error');
                return;
            }
            
            try {
                const response = await fetch('/combine_classes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        classes: Array.from(classesToCombine),
                        combined_name: combinedName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Successfully combined ${classesToCombine.size} classes into "${result.combined_name}" (${result.student_count} students)`, 'success');
                    
                    // Update the class list
                    currentClasses = result.classes;
                    
                    // Exit combine mode
                    cancelCombineMode();
                    
                    // Refresh the display
                    populateClassList();
                    
                    // Close modal
                    closeCombineModal();
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }
    </script>
</body>
</html>